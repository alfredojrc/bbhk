# Google Cloud Platform Penetration Testing Methodology
## Target: ihgroup.to & hpch.ch Infrastructure

**Date**: 2025-11-20
**Authorization**: Confirmed by owner for non-production testing
**Targets**:
- test/prod/dev.ihgroup.to ‚Üí 136.110.148.157 (GCP)
- test/prod/dev.hpch.ch ‚Üí 34.8.134.55 (GCP)

---

## PHASE 1: IP ADDRESS VERIFICATION ‚úÖ

### 1.1 WHOIS Analysis (COMPLETED)

**Target 1: 136.110.148.157**
```
NetRange:  136.107.0.0 - 136.111.255.255
NetName:   GOOGL-2
Organization: Google LLC
Location:  Mountain View, CA
CONFIRMED: Google Cloud Platform
```

**Target 2: 34.8.134.55**
```
NetRange:  34.4.5.0 - 34.63.255.255
NetName:   GOOGL-2
Organization: Google LLC
Location:  Mountain View, CA
CONFIRMED: Google Cloud Platform
```

### 1.2 GCP Region Detection

**Commands to identify regions**:
```bash
# Check reverse DNS for region hints
host 136.110.148.157
host 34.8.134.55

# Check for GCP metadata (if accessible)
curl -H "Metadata-Flavor: Google" http://169.254.169.254/computeMetadata/v1/instance/zone

# Use GCP IP ranges to narrow down region
curl -s https://www.gstatic.com/ipranges/cloud.json | jq -r '.prefixes[] | select(.ipv4Prefix | contains("136.110")) | .scope'
```

**Likely Regions** (based on IP ranges):
- Both IPs are in GCP public IP space
- 34.8.x.x range typically used for: us-central1, europe-west1, asia-southeast1
- 136.110.x.x range is newer allocation (2024-08-01)

---

## PHASE 2: WAF/IDS/IPS DETECTION

### 2.1 Google Cloud Armor Detection

**IMPORTANT**: wafw00f **DOES** support Google Cloud Armor detection!
```bash
# Confirmed detection signature available:
Google Cloud App Armor ‚Üí Google Cloud
```

### 2.2 Detection Methodology

#### **Step 1: Passive Detection (Low Risk)**

```bash
# 1. Check HTTP headers for GCP fingerprints
curl -I https://test.ihgroup.to
curl -I https://test.hpch.ch

# Look for these headers:
# - Server: Google Frontend
# - Via: 1.1 google
# - X-Cloud-Trace-Context: (GCP-specific)
# - X-Goog-* headers
# - Alt-Svc: h3=":443" (Google QUIC)

# 2. Use wafw00f for automated detection
wafw00f -v https://test.ihgroup.to
wafw00f -v https://test.hpch.ch

# 3. Check SSL/TLS certificate
openssl s_client -connect test.ihgroup.to:443 -servername test.ihgroup.to < /dev/null | grep -E "(Issuer|Subject|Google)"

# 4. Analyze response timing patterns
for i in {1..10}; do
  curl -w "%{time_total}\n" -o /dev/null -s https://test.ihgroup.to
done
```

#### **Step 2: Active Detection (Moderate Risk)**

```bash
# Use nmap NSE scripts for WAF detection
nmap -p 443 --script http-waf-detect --script-args="http-waf-detect.detectBodyChanges" 136.110.148.157
nmap -p 443 --script http-waf-fingerprint 136.110.148.157

# Test with whatweb
whatweb -v https://test.ihgroup.to

# Test with nikto (more aggressive)
nikto -host https://test.ihgroup.to -Tuning 1 -Display V
```

#### **Step 3: Behavioral Analysis (Higher Risk)**

```bash
# Send benign malicious-looking request to trigger WAF
curl -H "User-Agent: sqlmap/1.0" https://test.ihgroup.to
curl "https://test.ihgroup.to/?id=1' OR '1'='1" -v

# Check for:
# - 403 Forbidden responses
# - Rate limiting (429 Too Many Requests)
# - Custom error pages
# - Changed response codes/body
```

### 2.3 Google Cloud Armor Indicators

**Positive Detection Signs**:
1. **HTTP Headers**:
   - `Server: Google Frontend`
   - `Via: 1.1 google`
   - Custom `X-Goog-*` headers
   - `X-Cloud-Trace-Context` header

2. **Error Pages**:
   - GCP-styled 403/429 error pages
   - Error IDs in format: `Error: Error403`
   - References to Cloud Armor policy

3. **Behavioral Patterns**:
   - Rate limiting kicks in at predictable thresholds
   - JA3/JA4 fingerprinting active (SSL/TLS client detection)
   - Request body inspection (up to 64KB in new versions)
   - Consistent blocking of OWASP Core Rule Set patterns

4. **SSL/TLS**:
   - Google Trust Services certificates
   - Support for QUIC/HTTP3 (Alt-Svc header)

---

## PHASE 3: SAFE SCANNING PRACTICES FOR GCP

### 3.1 Google Cloud Penetration Testing Policy

**Authorization Requirements**:
- ‚úÖ NO prior notification to Google required for authorized testing
- ‚úÖ Must comply with GCP Acceptable Use Policy (AUP)
- ‚úÖ Must limit testing to resources YOU control
- ‚ùå No testing of other customers' resources
- ‚ùå No DoS/DDoS attacks
- ‚ùå No social engineering against Google employees
- ‚ùå No physical security testing of Google facilities

**Reference**: https://support.google.com/cloud/answer/6262505

### 3.2 Recommended Scan Rates

#### **Nmap Timing Templates for GCP**

```bash
# PHASE 1: Initial Discovery (SAFEST)
nmap -T2 -Pn -p 80,443,8080,8443 136.110.148.157
# -T2 = Polite timing (less bandwidth, slower)
# -Pn = Skip ping (many cloud hosts block ICMP)

# PHASE 2: Service Enumeration (MODERATE)
nmap -T3 -Pn -sV -p- --version-intensity 2 136.110.148.157
# -T3 = Normal timing (default)
# -sV = Version detection
# --version-intensity 2 = Lighter probing

# PHASE 3: Detailed Analysis (ONLY if Phase 1-2 successful)
nmap -T3 -Pn -sC -sV -p 80,443 --script="not intrusive and not dos" 136.110.148.157
# -sC = Safe scripts only
# Exclude intrusive/DoS scripts

# AVOID: Aggressive/Insane timing
# ‚ùå nmap -T4/-T5 (Will likely trigger rate limiting)
```

#### **Rate Limiting Recommendations**

```bash
# Conservative approach for authorized testing
# - Max 10 requests/second per target
# - 100ms delay between requests
# - Randomize scan timing to avoid patterns

# Using masscan (faster but noisier)
masscan -p1-65535 136.110.148.157 --rate=100 --wait 3
# --rate=100 = 100 packets/second (very conservative)
# --wait=3 = Wait 3 seconds after completion

# Using nuclei (for vulnerability scanning)
nuclei -u https://test.ihgroup.to -rl 10 -c 5
# -rl 10 = Rate limit: 10 requests/second
# -c 5 = 5 concurrent templates max
```

### 3.3 Best Practices for Stealth

1. **Use Distributed Sources** (if authorized):
   ```bash
   # Rotate user agents
   curl -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64)" https://test.ihgroup.to

   # Use proxies (if you control them)
   wafw00f -p http://your-proxy:8080 https://test.ihgroup.to
   ```

2. **Time-Based Scanning**:
   ```bash
   # Scan during low-traffic periods
   # Add random delays between requests
   for ip in 136.110.148.157 34.8.134.55; do
     nmap -T2 -Pn -p 80,443 $ip
     sleep $((RANDOM % 60 + 30))  # Random 30-90s delay
   done
   ```

3. **Incremental Intensity**:
   ```
   Level 1 (Passive):  DNS, WHOIS, SSL cert analysis
   Level 2 (Light):    Single-port scans, wafw00f
   Level 3 (Moderate): Service enumeration, version detection
   Level 4 (Active):   Vulnerability scanning with rate limits
   ```

---

## PHASE 4: INITIAL RECONNAISSANCE COMMANDS

### 4.1 Safe Stealth Reconnaissance (START HERE)

```bash
# Step 1: DNS Enumeration
dig test.ihgroup.to ANY
dig dev.ihgroup.to ANY
dig prod.ihgroup.to ANY
host -a ihgroup.to

dig test.hpch.ch ANY
dig dev.hpch.ch ANY
dig prod.hpch.ch ANY
host -a hpch.ch

# Step 2: Subdomain Discovery (Passive)
subfinder -d ihgroup.to -silent -o ihgroup_subdomains.txt
subfinder -d hpch.ch -silent -o hpch_subdomains.txt

# Step 3: HTTP/HTTPS Probing
cat ihgroup_subdomains.txt | httpx -silent -status-code -tech-detect
cat hpch_subdomains.txt | httpx -silent -status-code -tech-detect

# Step 4: Technology Fingerprinting
whatweb -v https://test.ihgroup.to --log-verbose=whatweb_ihgroup.log
whatweb -v https://test.hpch.ch --log-verbose=whatweb_hpch.log

# Step 5: SSL/TLS Analysis
echo | openssl s_client -connect test.ihgroup.to:443 -servername test.ihgroup.to 2>/dev/null | openssl x509 -noout -text
nmap --script ssl-cert,ssl-enum-ciphers -p 443 136.110.148.157
```

### 4.2 WAF/IDS Detection Phase

```bash
# Step 6: WAF Detection with wafw00f
wafw00f -v -a https://test.ihgroup.to -o ihgroup_waf.json -f json
wafw00f -v -a https://test.hpch.ch -o hpch_waf.json -f json

# Step 7: Nmap WAF Fingerprinting
nmap -p 443 --script http-waf-detect,http-waf-fingerprint 136.110.148.157 -oN ihgroup_waf_nmap.txt
nmap -p 443 --script http-waf-detect,http-waf-fingerprint 34.8.134.55 -oN hpch_waf_nmap.txt

# Step 8: Manual Header Analysis
curl -I -H "User-Agent: Mozilla/5.0" https://test.ihgroup.to > ihgroup_headers.txt
curl -I -H "User-Agent: Mozilla/5.0" https://test.hpch.ch > hpch_headers.txt
```

### 4.3 Port Scanning (Conservative)

```bash
# Step 9: Top 1000 ports with polite timing
nmap -T2 -Pn --top-ports 1000 136.110.148.157 -oN ihgroup_ports.txt
nmap -T2 -Pn --top-ports 1000 34.8.134.55 -oN hpch_ports.txt

# Step 10: Service version detection on open ports
# (Only run on discovered open ports)
nmap -T2 -Pn -sV -p 80,443,8080,8443 136.110.148.157 -oN ihgroup_services.txt
nmap -T2 -Pn -sV -p 80,443,8080,8443 34.8.134.55 -oN hpch_services.txt
```

---

## PHASE 5: KALI TOOLS FOR WAF/IDS DETECTION

### 5.1 Available Tools (Verified on System)

| Tool | Status | Purpose | Stealth Level |
|------|--------|---------|---------------|
| **wafw00f** | ‚úÖ Installed | WAF fingerprinting | High (passive) |
| **nmap** | ‚úÖ Installed | Port scanning, NSE scripts | Medium |
| **masscan** | ‚úÖ Installed | Fast port scanning | Low (noisy) |
| **httpx** | ‚úÖ Installed | HTTP probing, tech detection | High |
| **subfinder** | ‚úÖ Installed | Subdomain enumeration | High (passive) |
| **nuclei** | ‚úÖ Installed | Vulnerability scanning | Medium |
| **whatweb** | ‚úÖ Installed | Web tech fingerprinting | High |
| **nikto** | ‚úÖ Installed | Web server scanning | Low (very noisy) |
| **curl** | ‚úÖ Installed | HTTP requests | High |
| **dig/host** | ‚úÖ Installed | DNS queries | High (passive) |
| **whatwaf** | ‚ùå Not installed | Alternative WAF detector | N/A |

### 5.2 Nmap NSE Scripts for WAF/IDS

```bash
# Available scripts:
/usr/share/nmap/scripts/http-waf-detect.nse      # Detect WAF presence
/usr/share/nmap/scripts/http-waf-fingerprint.nse # Identify WAF vendor
/usr/share/nmap/scripts/firewall-bypass.nse      # Test firewall rules

# Usage examples:
nmap --script http-waf-detect --script-args="http-waf-detect.aggro" -p 443 target.com
nmap --script http-waf-fingerprint -p 80,443 target.com
```

### 5.3 Installing Missing Tools

```bash
# Install whatwaf (if needed)
git clone https://github.com/Ekultek/WhatWaf.git /opt/whatwaf
cd /opt/whatwaf
pip3 install -r requirements.txt
chmod +x whatwaf
ln -s /opt/whatwaf/whatwaf /usr/local/bin/whatwaf

# Usage:
whatwaf -u https://test.ihgroup.to --verbose
```

---

## PHASE 6: GOOGLE CLOUD ARMOR SPECIFIC TESTS

### 6.1 Detecting Cloud Armor Features

```bash
# Test 1: JA3/JA4 Fingerprinting Detection
# Cloud Armor now uses JA4 (enhanced SSL/TLS fingerprinting)
# Normal browsers should work, scanners may get blocked

curl --tlsv1.2 https://test.ihgroup.to -v 2>&1 | grep -E "(SSL|TLS)"
curl --user-agent "curl/7.0" https://test.ihgroup.to -v  # Unusual UA

# Test 2: Request Body Inspection (up to 64KB)
# POST large JSON payload to test inspection depth
curl -X POST https://test.ihgroup.to -H "Content-Type: application/json" \
  -d '{"test":"'$(python3 -c 'print("A"*65000)')'"}'

# Test 3: Rate Limiting Detection
for i in {1..100}; do
  curl -s -o /dev/null -w "%{http_code}\n" https://test.ihgroup.to
  sleep 0.1
done | sort | uniq -c
# Look for transition from 200 ‚Üí 429 (Too Many Requests)

# Test 4: OWASP Core Rule Set Detection
# Cloud Armor uses OWASP CRS v3.3
curl "https://test.ihgroup.to/?q=<script>alert(1)</script>" -v
curl "https://test.ihgroup.to/?id=1' OR '1'='1" -v
curl "https://test.ihgroup.to" -H "User-Agent: () { :; }; echo vulnerable" -v
```

### 6.2 Bypass Attempts (For Testing Defenses)

```bash
# Note: These are for AUTHORIZED testing only!

# Test 1: Case manipulation
curl "https://test.ihgroup.to/?q=<ScRiPt>alert(1)</sCrIpT>"

# Test 2: URL encoding
curl "https://test.ihgroup.to/?q=%3Cscript%3Ealert(1)%3C%2Fscript%3E"

# Test 3: Null byte injection
curl "https://test.ihgroup.to/?q=<script>%00alert(1)</script>"

# Test 4: Header injection
curl https://test.ihgroup.to -H "X-Forwarded-For: 127.0.0.1"
curl https://test.ihgroup.to -H "X-Original-URL: /admin"
```

---

## PHASE 7: DOCUMENTATION & REPORTING

### 7.1 Data to Collect

```bash
# Create organized directory structure
mkdir -p /home/kali/bbhk/hacks/ihgroup-hpch-pentest/{recon,scans,screenshots,reports}

# Save all outputs
# - DNS records
# - WHOIS data
# - Port scan results
# - WAF detection results
# - HTTP headers
# - SSL certificates
# - Technology fingerprints
# - Screenshot evidence
```

### 7.2 Key Metrics to Track

1. **WAF/IDS Presence**: Confirmed/Not Detected
2. **Rate Limiting Threshold**: X requests/second
3. **Blocking Rules**: OWASP CRS rules active
4. **SSL/TLS Configuration**: Cipher suites, protocols
5. **Technology Stack**: Web server, frameworks, CDN
6. **Open Ports**: List of accessible services
7. **Subdomains**: test/dev/prod variants

---

## RECOMMENDED SCANNING SEQUENCE

### Initial Reconnaissance (Day 1 - Passive)
```bash
1. WHOIS/DNS enumeration          [30 min]
2. Subdomain discovery (passive)  [1 hour]
3. SSL/TLS certificate analysis   [30 min]
4. Technology fingerprinting      [1 hour]
```

### Active Reconnaissance (Day 2 - Low Impact)
```bash
5. WAF detection (wafw00f)        [30 min]
6. HTTP header analysis           [30 min]
7. Top 100 ports scan (-T2)       [2 hours]
8. Service version detection      [1 hour]
```

### Vulnerability Assessment (Day 3+ - Moderate Impact)
```bash
9. WAF bypass testing             [2 hours]
10. Nuclei vulnerability scans    [3 hours]
11. Manual application testing    [Ongoing]
```

---

## SAFETY CHECKLIST

Before starting ANY scanning:
- [ ] Confirm written authorization from target owner
- [ ] Verify you're targeting correct IP addresses
- [ ] Start with passive reconnaissance only
- [ ] Use conservative timing (-T2 or slower)
- [ ] Monitor for rate limiting/blocking
- [ ] Document all activities with timestamps
- [ ] Have incident response plan ready
- [ ] Know who to contact if issues arise

**STOP scanning immediately if**:
- You receive 403/429 errors repeatedly
- You detect unusual latency or timeouts
- You receive legal/abuse notifications
- You're unsure about authorization scope

---

## QUICK REFERENCE COMMANDS

```bash
# Minimal stealth scan
nmap -T2 -Pn --top-ports 100 -oN scan.txt TARGET_IP

# WAF detection
wafw00f -v https://TARGET_DOMAIN

# Safe vulnerability scan
nuclei -u https://TARGET_DOMAIN -rl 5 -severity critical,high

# Technology fingerprint
whatweb -v https://TARGET_DOMAIN

# DNS reconnaissance
subfinder -d TARGET_DOMAIN -silent | httpx -silent -tech-detect
```

---

## REFERENCES

- Google Cloud Security FAQ: https://support.google.com/cloud/answer/6262505
- Cloud Armor Documentation: https://cloud.google.com/armor/docs
- OWASP CRS v3.3: https://owasp.org/www-project-modsecurity-core-rule-set/
- Nmap Timing Templates: https://nmap.org/book/performance-timing-templates.html
- wafw00f GitHub: https://github.com/EnableSecurity/wafw00f

---

**Document Version**: 1.0
**Last Updated**: 2025-11-20
**Author**: BBHK Scout Agent üó∫Ô∏è
