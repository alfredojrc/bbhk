#!/bin/bash
#
# Quick Reconnaissance Script for GCP Infrastructure
# Targets: ihgroup.to & hpch.ch
#
# USAGE: ./quick-recon.sh [passive|active|full]
#
# Modes:
#   passive - Only passive reconnaissance (safe, undetectable)
#   active  - Active scanning with conservative timing
#   full    - Complete reconnaissance (requires authorization)
#

set -e

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Targets
DOMAIN1="ihgroup.to"
DOMAIN2="hpch.ch"
IP1="136.110.148.157"
IP2="34.8.134.55"

# Output directory
OUTDIR="/home/kali/bbhk/hacks/ihgroup-hpch-pentest/recon"
mkdir -p "$OUTDIR"/{dns,waf,ports,tech,ssl}

# Timestamp for unique filenames
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

# Mode selection
MODE="${1:-passive}"

# Banner
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${BLUE}   GCP Infrastructure Reconnaissance - Scout ğŸ—ºï¸${NC}"
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${YELLOW}Targets:${NC}"
echo -e "  â€¢ $DOMAIN1 â†’ $IP1"
echo -e "  â€¢ $DOMAIN2 â†’ $IP2"
echo -e "${YELLOW}Mode:${NC} $MODE"
echo -e "${YELLOW}Output:${NC} $OUTDIR"
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"

# Safety check
echo -e "${RED}âš ï¸  AUTHORIZATION CHECK${NC}"
echo -e "Do you have WRITTEN authorization to test these targets? (yes/no)"
read -r AUTHORIZED

if [ "$AUTHORIZED" != "yes" ]; then
    echo -e "${RED}âŒ Authorization not confirmed. Exiting.${NC}"
    exit 1
fi

echo -e "\n${GREEN}âœ… Starting reconnaissance...${NC}\n"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PASSIVE RECONNAISSANCE (Always Safe)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if [ "$MODE" = "passive" ] || [ "$MODE" = "full" ]; then
    echo -e "${BLUE}[Phase 1] Passive Reconnaissance${NC}"

    # DNS Enumeration
    echo -e "${YELLOW}â†’ DNS enumeration...${NC}"
    for domain in $DOMAIN1 $DOMAIN2; do
        echo -e "  Querying $domain..."
        dig $domain ANY > "$OUTDIR/dns/${domain}_any_${TIMESTAMP}.txt" 2>&1 || true
        dig $domain A AAAA MX TXT NS SOA > "$OUTDIR/dns/${domain}_records_${TIMESTAMP}.txt" 2>&1 || true
        host -a $domain > "$OUTDIR/dns/${domain}_host_${TIMESTAMP}.txt" 2>&1 || true
    done
    echo -e "${GREEN}  âœ“ DNS enumeration complete${NC}\n"

    # WHOIS Lookup
    echo -e "${YELLOW}â†’ WHOIS lookups...${NC}"
    whois $IP1 > "$OUTDIR/dns/${DOMAIN1}_whois_${TIMESTAMP}.txt" 2>&1 || true
    whois $IP2 > "$OUTDIR/dns/${DOMAIN2}_whois_${TIMESTAMP}.txt" 2>&1 || true
    echo -e "${GREEN}  âœ“ WHOIS complete${NC}\n"

    # Subdomain Discovery (Passive)
    echo -e "${YELLOW}â†’ Subdomain discovery (passive)...${NC}"
    if command -v subfinder &> /dev/null; then
        for domain in $DOMAIN1 $DOMAIN2; do
            echo -e "  Enumerating $domain subdomains..."
            subfinder -d $domain -silent -o "$OUTDIR/dns/${domain}_subdomains_${TIMESTAMP}.txt" 2>&1 || true
        done
        echo -e "${GREEN}  âœ“ Subdomain discovery complete${NC}\n"
    else
        echo -e "${RED}  âš ï¸  subfinder not installed, skipping${NC}\n"
    fi

    # SSL/TLS Certificate Analysis
    echo -e "${YELLOW}â†’ SSL/TLS certificate analysis...${NC}"
    for domain in test.$DOMAIN1 test.$DOMAIN2; do
        echo -e "  Analyzing $domain certificate..."
        echo | openssl s_client -connect $domain:443 -servername $domain 2>/dev/null | \
            openssl x509 -noout -text > "$OUTDIR/ssl/${domain}_cert_${TIMESTAMP}.txt" 2>&1 || true
    done
    echo -e "${GREEN}  âœ“ SSL/TLS analysis complete${NC}\n"

    # Technology Fingerprinting
    echo -e "${YELLOW}â†’ Technology fingerprinting...${NC}"
    if command -v whatweb &> /dev/null; then
        for domain in test.$DOMAIN1 test.$DOMAIN2; do
            echo -e "  Fingerprinting https://$domain..."
            whatweb -v https://$domain --log-verbose="$OUTDIR/tech/${domain}_whatweb_${TIMESTAMP}.log" 2>&1 || true
        done
        echo -e "${GREEN}  âœ“ Technology fingerprinting complete${NC}\n"
    else
        echo -e "${RED}  âš ï¸  whatweb not installed, skipping${NC}\n"
    fi

    # HTTP Headers Collection
    echo -e "${YELLOW}â†’ HTTP headers collection...${NC}"
    for domain in test.$DOMAIN1 test.$DOMAIN2; do
        echo -e "  Collecting headers from https://$domain..."
        curl -I -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            https://$domain > "$OUTDIR/tech/${domain}_headers_${TIMESTAMP}.txt" 2>&1 || true
    done
    echo -e "${GREEN}  âœ“ HTTP headers collected${NC}\n"

    echo -e "${GREEN}âœ… Passive reconnaissance complete!${NC}\n"
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ACTIVE RECONNAISSANCE (Requires Authorization)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if [ "$MODE" = "active" ] || [ "$MODE" = "full" ]; then
    echo -e "${BLUE}[Phase 2] Active Reconnaissance (Conservative)${NC}"

    # WAF Detection with wafw00f
    echo -e "${YELLOW}â†’ WAF detection (wafw00f)...${NC}"
    if command -v wafw00f &> /dev/null; then
        for domain in test.$DOMAIN1 test.$DOMAIN2; do
            echo -e "  Testing https://$domain for WAF..."
            wafw00f -v -a https://$domain -o "$OUTDIR/waf/${domain}_wafw00f_${TIMESTAMP}.json" -f json 2>&1 || true
        done
        echo -e "${GREEN}  âœ“ WAF detection complete${NC}\n"
    else
        echo -e "${RED}  âš ï¸  wafw00f not installed, skipping${NC}\n"
    fi

    # Nmap WAF Fingerprinting
    echo -e "${YELLOW}â†’ Nmap WAF fingerprinting...${NC}"
    for ip in $IP1 $IP2; do
        domain=$([ "$ip" = "$IP1" ] && echo "$DOMAIN1" || echo "$DOMAIN2")
        echo -e "  Scanning $ip ($domain)..."
        nmap -p 443 --script http-waf-detect,http-waf-fingerprint $ip \
            -oN "$OUTDIR/waf/${domain}_nmap_waf_${TIMESTAMP}.txt" 2>&1 || true
    done
    echo -e "${GREEN}  âœ“ Nmap WAF fingerprinting complete${NC}\n"

    # Port Scanning (Top 1000, Polite Timing)
    echo -e "${YELLOW}â†’ Port scanning (top 1000 ports, -T2 polite)...${NC}"
    echo -e "${RED}  âš ï¸  This may take 10-15 minutes per host${NC}"
    for ip in $IP1 $IP2; do
        domain=$([ "$ip" = "$IP1" ] && echo "$DOMAIN1" || echo "$DOMAIN2")
        echo -e "  Scanning $ip ($domain)..."
        nmap -T2 -Pn --top-ports 1000 $ip \
            -oN "$OUTDIR/ports/${domain}_top1000_${TIMESTAMP}.txt" 2>&1 || true
    done
    echo -e "${GREEN}  âœ“ Port scanning complete${NC}\n"

    # Service Version Detection (Common Web Ports)
    echo -e "${YELLOW}â†’ Service version detection (80,443,8080,8443)...${NC}"
    for ip in $IP1 $IP2; do
        domain=$([ "$ip" = "$IP1" ] && echo "$DOMAIN1" || echo "$DOMAIN2")
        echo -e "  Detecting services on $ip ($domain)..."
        nmap -T2 -Pn -sV -p 80,443,8080,8443 $ip \
            -oN "$OUTDIR/ports/${domain}_services_${TIMESTAMP}.txt" 2>&1 || true
    done
    echo -e "${GREEN}  âœ“ Service detection complete${NC}\n"

    echo -e "${GREEN}âœ… Active reconnaissance complete!${NC}\n"
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SUMMARY REPORT
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${BLUE}   Reconnaissance Summary${NC}"
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${GREEN}âœ“ All scans completed successfully${NC}"
echo -e ""
echo -e "${YELLOW}Results saved to:${NC}"
echo -e "  ğŸ“ $OUTDIR"
echo -e ""
echo -e "${YELLOW}Next Steps:${NC}"
echo -e "  1. Review results: ${GREEN}ls -R $OUTDIR${NC}"
echo -e "  2. Check WAF detection: ${GREEN}cat $OUTDIR/waf/*_wafw00f_*.json${NC}"
echo -e "  3. Analyze headers: ${GREEN}cat $OUTDIR/tech/*_headers_*.txt${NC}"
echo -e "  4. Review open ports: ${GREEN}cat $OUTDIR/ports/*_top1000_*.txt${NC}"
echo -e ""
echo -e "${YELLOW}GCP-Specific Indicators to Check:${NC}"
echo -e "  â€¢ Server: Google Frontend"
echo -e "  â€¢ Via: 1.1 google"
echo -e "  â€¢ X-Cloud-Trace-Context header"
echo -e "  â€¢ Google Cloud App Armor (WAF)"
echo -e ""
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${GREEN}Happy Hunting! ğŸ¯${NC}"
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"

# Generate quick stats
echo -e "${YELLOW}Quick Stats:${NC}"
echo -e "  Files created: $(find $OUTDIR -type f | wc -l)"
echo -e "  Total size: $(du -sh $OUTDIR | cut -f1)"
echo -e "  Timestamp: $TIMESTAMP"
echo -e ""
